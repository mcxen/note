# Redis

## 数据持久化

### Redis 保证数据不丢失？

Redis 保证数据不丢失的主要手段有两个：

1. 持久化
2. 集群运行

### 1.Redis 持久化

持久化是指将数据从内存中存储到持久化存储介质中（如硬盘）的过程，以便在程序重启或者系统崩溃等情况下，能够从持久化存储介质中恢复数据。

Redis 4.0 之后支持以下 3 种持久化方案：

1. **RDB（Redis DataBase）持久化**：快照方式持久化，将某一个时刻的内存数据，以二进制的方式写入磁盘；
2. **AOF（Append Only File）持久化**：文件追加持久化，记录所有非查询操作命令，并以文本的形式追加到文件中；
3. **混合持久化：RDB + AOF 混合方式的持久化**，Redis 4.0 之后新增的方式，混合持久化是结合了 RDB 和 AOF 的优点，在写入的时候，先把当前的数据以 RDB 的形式写入文件的开头，再将后续的操作命令以 AOF 的格式存入文件，这样既能保证 Redis 重启时的速度，又能减低数据丢失的风险。

#### [#](#_1-1-rdb-持久化) 1.1 RDB 持久化

RDB（Redis Database）是将某一个时刻的内存快照（Snapshot），以二进制的方式写入磁盘的持久化机制。

RDB 持久化机制有以下优缺点：

**优点：**

1. 速度快：相对于 AOF 持久化方式，RDB 持久化速度更快，因为它只需要在指定的时间间隔内将数据从内存中写入到磁盘上。
2. 空间占用小：RDB 持久化会将数据保存在一个压缩的二进制文件中，因此相对于 AOF 持久化方式，它占用的磁盘空间更小。
3. 恢复速度快：因为 RDB 文件是一个完整的数据库快照，所以在 Redis 重启后，可以非常快速地将数据恢复到内存中。
4. 可靠性高：RDB 持久化方式可以保证数据的可靠性，因为数据会在指定时间间隔内自动写入磁盘，即使 Redis 进程崩溃或者服务器断电，也可以通过加载最近的一次快照文件恢复数据。

**缺点：**

1. 数据可能会丢失：RDB 持久化方式只能保证数据在指定时间间隔内写入磁盘，因此如果 Redis 进程崩溃或者服务器断电，从最后一次快照保存到崩溃的时间点之间的数据可能会丢失。
2. 实时性差：因为 RDB 持久化是定期执行的，因此从最后一次快照保存到当前时间点之间的数据可能会丢失。如果需要更高的实时性，可以使用 AOF 持久化方式。

所以，RDB 持久化方式适合用于对数据可靠性要求较高，但对实时性要求不高的场景，如 Redis 中的备份和数据恢复等。

#### [#](#_1-2-aof-持久化) 1.2 AOF 持久化

AOF（Append Only File）它是将 Redis 每个非查询操作命令都追加记录到文件（appendonly.aof）中的持久化机制。

AOF 持久化机制有以下优缺点：

**优点：**

1. 数据不容易丢失：AOF 持久化方式会将 Redis 执行的每一个写命令记录到一个文件中，因此即使 Redis 进程崩溃或者服务器断电，也可以通过重放 AOF 文件中的命令来恢复数据。
2. 实时性好：由于 AOF 持久化方式是将每一个写命令记录到文件中，因此它的实时性比 RDB 持久化方式更好。
3. 数据可读性强：AOF 持久化文件是一个纯文本文件，可以被人类读取和理解，因此可以方便地进行数据备份和恢复操作。

**缺点：**

1. 写入性能略低：由于 AOF 持久化方式需要将每一个写命令记录到文件中，因此相对于 RDB 持久化方式，它的写入性能略低。
2. 占用磁盘空间大：由于 AOF 持久化方式需要记录每一个写命令，因此相对于 RDB 持久化方式，它占用的磁盘空间更大。
3. AOF 文件可能会出现损坏：由于 AOF 文件是不断地追加写入的，因此如果文件损坏，可能会导致数据无法恢复。

所以，AOF 持久化方式适合用于对数据实时性要求较高，但对数据大小和写入性能要求相对较低的场景，如需要对数据进行实时备份的应用场景。

#### [#](#_1-3-混合持久化) 1.3 混合持久化

Redis 混合持久化是指将 RDB 持久化方式和 AOF 持久化方式结合起来使用，以充分发挥它们的优势，同时避免它们的缺点。

它的优缺点如下：

**优点：**

混合持久化结合了 RDB 和 AOF 持久化的优点，开头为 RDB 的格式，使得 Redis 可以更快的启动，同时结合 AOF 的优点，有减低了大量数据丢失的风险。

**缺点：**

1. 实现复杂度高：混合持久化需要同时维护 RDB 文件和 AOF 文件，因此实现复杂度相对于单独使用 RDB 或 AOF 持久化方式要高。
2. 可读性差：AOF 文件中添加了 RDB 格式的内容，使得 AOF 文件的可读性变得很差；
3. 兼容性差：如果开启混合持久化，那么此混合持久化 AOF 文件，就不能用在 Redis 4.0 之前版本了。

所以，Redis 混合持久化方式适合用于，需要兼顾启动速度和减低数据丢失的场景。但需要注意的是，混合持久化的实现复杂度较高、可读性差，只能用于 Redis 4.0 以上版本，因此在选择时需要根据实际情况进行权衡。

### [#](#_2-redis-集群) 2.Redis 集群

Redis 集群是将原先的单服务器，变为了多服务器，这样 Redis 保存的数据也从一台服务器变成了多台服务器，这样即使有一台服务器出问题了，其他的服务器还有备份数据。所以使用 Redis 集群除了可以保证高可用，还保证了数据不丢失。

Redis 集群运行有以下 3 种方案：

1. 主从同步
2. 哨兵模式
3. Redis Cluster

#### [#](#_2-1-主从同步) 2.1 主从同步

主从同步 (主从复制) 是 Redis 高可用服务的基石，也是多机运行中最基础的一个。我们把主要存储数据的节点叫做主节点 (master)，把其他通过复制主节点数据的副本节点叫做从节点 (slave)，如下图所示：

![img](https://cdn.jsdelivr.net/gh/52chen/imagebed2023@main/picgo/1582086579618-3ea491f7-a887-4380-9f48-84237675cec5.png)

在 Redis 中一个主节点可以拥有多个从节点，一个从节点也可以是其他服务器的主节点，如下图所示：

![img](https://cdn.jsdelivr.net/gh/52chen/imagebed2023@main/picgo/1582086587052-ff6c03d7-28d4-4881-bc5b-55c5b277e5ae.png)

#### [#](#_2-2-哨兵模式) 2.2 哨兵模式

主从同步存在一个致命的问题，当主节点奔溃之后，需要人工干预才能恢复 Redis 的正常使用。 所以我们需要一个自动的工具——Redis Sentinel (哨兵模式) 来把手动的过程变成自动的，让 Redis 拥有自动容灾恢复 (failover) 的能力。 哨兵模式如下所示：

![img](https://cdn.jsdelivr.net/gh/52chen/imagebed2023@main/picgo/1582100659240-40cfcd46-0c43-4808-a1cf-32b970f98ef6.png)

> 小贴士：Redis Sentinel 的最小分配单位是一主一从。

#### [#](#_2-3-redis-cluster) 2.3 Redis Cluster

Redis Cluster 是 Redis 3.0 版本推出的 Redis 集群方案，它将数据分布在不同的服务区上，以此来降低系统对单主节点的依赖，并且可以大大的提高 Redis 服务的读写性能。 Redis Cluster 架构图如下所示：

![img](https://cdn.jsdelivr.net/gh/52chen/imagebed2023@main/picgo/1585148925496-361a449a-145e-44f2-a414-a46319140e1d.png)

从上图可以看出 Redis 的主从同步只能有一个主节点，而 Redis Cluster 可以拥有无数个主从节点，因此 Redis Cluster 拥有更强大的平行扩展能力，也就是说当 Redis Cluster 拥有两个主从节点时，从理论上来讲 Redis 的性能相比于主从来说性能提升了两倍，并且 Redis Cluster 也有自动容灾恢复的机制。

#### [#](#小结) 小结

Redis 保证数据不丢失的主要手段有两个：持久化和集群运行。其中持久化有三种实现：RDB、AOF、混合持久化；而集群（运行）也包含了三种实现：主从复制、哨兵模式和 Redis Cluster。

